<!-- templates/direct_chat.html -->
{% extends "base.html" %}

{% block content %}
<div class="mobile-app">
    <!-- Header -->
    <div class="header safe-area-top">
        <button class="header-button ripple" onclick="goBack()">‚Üê</button>
        <div class="chat-user-info" style="flex: 1; display: flex; align-items: center; gap: 12px;">
            <div class="chat-avatar" style="width: 40px; height: 40px; font-size: 16px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                {{ receiver.username[0]|upper }}
            </div>
            <div>
                <div class="chat-name" style="font-size: 16px; font-weight: 500;">{{ receiver.username }}</div>
                <div class="chat-status" id="userStatus" style="font-size: 13px; color: var(--text-secondary);">Checking status...</div>
            </div>
        </div>
        <button class="header-button ripple" onclick="showUserMenu()">‚ãÆ</button>
    </div>

    <!-- Messages -->
    <div class="chat-view">
        <div class="messages-container" id="messagesContainer">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- File Upload Area -->
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <div id="uploadFileName">No file selected</div>
            <div class="upload-buttons">
                <button type="button" class="upload-button secondary ripple" onclick="document.getElementById('fileInput').click()">Choose File</button>
                <button type="button" class="upload-button primary ripple" onclick="uploadFile()" id="uploadBtn">Upload</button>
                <button type="button" class="upload-button cancel ripple" onclick="cancelUpload()">Cancel</button>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area safe-area-bottom">
            <form class="input-form" id="messageForm">
                <div class="input-row">
                    <button type="button" class="attachment-button ripple" onclick="toggleUploadArea()" id="attachmentBtn">üìé</button>
                    <textarea class="message-input" placeholder="Message" id="messageInput" rows="1"></textarea>
                    <button type="submit" class="send-button ripple" id="sendButton" disabled>‚û§</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Hidden file input -->
<input type="file" id="fileInput" class="file-input" onchange="handleFileSelect(this.files)">
<input type="hidden" id="receiverId" value="{{ receiver.id }}">
{% endblock %}

{% block styles %}
<style>
    /* Mobile-first responsive design - BLUE THEME */
    :root {
        --primary-color: #2196F3;
        --primary-light: rgba(33, 150, 243, 0.1);
        --primary-dark: #1976D2;
        --surface-color: #ffffff;
        --surface-variant: #f8f9fa;
        --border-color: #e0e0e0;
        --text-primary: #333333;
        --text-secondary: #666666;
        --text-disabled: #999999;
        --error-color: #f44336;
        --success-color: #4CAF50;
        --online-status: #4CAF50;
        --offline-status: #f44336;
        --away-status: #FF9800;
        --safe-area-top: env(safe-area-inset-top, 0px);
        --safe-area-bottom: env(safe-area-inset-bottom, 0px);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    html, body {
        height: 100%;
        overflow: hidden;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: var(--surface-color);
        color: var(--text-primary);
        line-height: 1.4;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* Mobile app container */
    .mobile-app {
        height: 100vh;
        height: -webkit-fill-available;
        display: flex;
        flex-direction: column;
        background: var(--surface-variant);
    }

    /* Header */
    .header {
        background: var(--primary-color);
        color: white;
        padding: 12px 15px;
        position: relative;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        flex-shrink: 0;
    }

    .safe-area-top {
        padding-top: calc(12px + var(--safe-area-top, 0px));
    }

    .ripple {
        position: relative;
        overflow: hidden;
    }

    .ripple:after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%);
        transform-origin: 50% 50%;
    }

    .ripple:focus:after {
        animation: ripple 0.6s ease-out;
    }

    @keyframes ripple {
        0% {
            transform: scale(0, 0);
            opacity: 0.5;
        }
        100% {
            transform: scale(20, 20);
            opacity: 0;
        }
    }

    .header-button {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 50%;
        transition: background-color 0.2s;
    }

    .header-button:hover,
    .header-button:active {
        background: rgba(255, 255, 255, 0.1);
    }

    /* Messages Container */
    .chat-view {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        padding: 16px 12px;
        scroll-behavior: smooth;
    }

    /* Message Styles */
    .message {
        margin: 12px 0;
        max-width: 85%;
        position: relative;
    }

    .message.outgoing {
        margin-left: auto;
    }

    .message.incoming {
        margin-right: auto;
    }

    .message-bubble {
        border-radius: 18px;
        padding: 12px 16px;
        position: relative;
        word-wrap: break-word;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.outgoing .message-bubble {
        background: var(--primary-color);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.incoming .message-bubble {
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-bottom-left-radius: 4px;
    }

    .bounce-in {
        animation: bounceIn 0.3s ease;
    }

    @keyframes bounceIn {
        0% {
            opacity: 0;
            transform: scale(0.3);
        }
        50% {
            opacity: 0.9;
            transform: scale(1.1);
        }
        80% {
            opacity: 1;
            transform: scale(0.89);
        }
        100% {
            opacity: 1;
            transform: scale(1);
        }
    }

    .message-text {
        font-size: 16px;
        line-height: 1.4;
        margin-bottom: 6px;
        white-space: pre-wrap;
    }

    .message-time {
        font-size: 11px;
        opacity: 0.7;
        text-align: right;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 4px;
    }

    .message.incoming .message-time {
        text-align: left;
        justify-content: flex-start;
    }

    .message-status {
        font-size: 10px;
        opacity: 0.9;
    }

    /* File Attachment Styles in Messages */
    .file-attachment {
        margin: 8px 0;
        border-radius: 12px;
        overflow: hidden;
        background: var(--surface-variant);
        border: 1px solid var(--border-color);
    }

    .message.outgoing .file-attachment {
        background: var(--primary-light);
        border-color: var(--primary-light);
    }

    .file-preview {
        text-align: center;
        padding: 12px;
    }

    .file-preview img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s ease;
    }

    .file-preview img:hover {
        transform: scale(1.02);
    }

    .file-preview audio,
    .file-preview video {
        width: 100%;
        border-radius: 8px;
        margin-top: 8px;
    }

    .attachment-icon {
        font-size: 2.5em;
        margin-bottom: 8px;
        opacity: 0.7;
        color: var(--text-secondary);
    }

    .file-info {
        padding: 10px 12px;
        background: rgba(0, 0, 0, 0.03);
        border-top: 1px solid var(--border-color);
    }

    .message.outgoing .file-info {
        background: rgba(255, 255, 255, 0.1);
    }

    .file-name {
        font-weight: 500;
        font-size: 14px;
        margin-bottom: 4px;
        word-break: break-all;
        color: var(--text-primary);
    }

    .file-size {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .file-download {
        display: inline-block;
        padding: 6px 12px;
        background: var(--primary-color);
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        transition: background 0.2s ease;
    }

    .file-download:hover {
        background: var(--primary-dark);
    }

    .message-content {
        margin-top: 8px;
    }

    /* File Upload Styles */
    .upload-area {
        background: var(--surface-color);
        border-top: 1px solid var(--border-color);
        padding: 15px;
        display: none;
        transition: all 0.3s ease;
    }

    .upload-area.active {
        display: block;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .upload-icon {
        font-size: 2.5em;
        text-align: center;
        margin-bottom: 10px;
        color: var(--primary-color);
        opacity: 0.8;
    }

    #uploadFileName {
        text-align: center;
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 15px;
        word-break: break-all;
        padding: 0 10px;
    }

    .upload-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    .upload-button {
        padding: 8px 16px;
        border-radius: 20px;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .upload-button.primary {
        background: var(--primary-color);
        color: white;
    }

    .upload-button.secondary {
        background: var(--surface-variant);
        color: var(--text-primary);
    }

    .upload-button.cancel {
        background: var(--error-color);
        color: white;
    }

    .upload-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .file-input {
        display: none;
    }

    /* Input Area */
    .input-area {
        background: var(--surface-color);
        border-top: 1px solid var(--border-color);
        padding: 12px;
        flex-shrink: 0;
        position: relative;
    }

    .safe-area-bottom {
        padding-bottom: calc(12px + var(--safe-area-bottom, 0px));
    }

    .input-form {
        display: flex;
        gap: 8px;
        align-items: flex-end;
    }

    .input-row {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        width: 100%;
    }

    .message-input {
        flex: 1;
        min-height: 44px;
        max-height: 120px;
        padding: 12px 16px;
        border: 1px solid var(--border-color);
        border-radius: 22px;
        font-size: 16px;
        font-family: inherit;
        background: var(--surface-variant);
        color: var(--text-primary);
        resize: none;
        outline: none;
        transition: all 0.2s;
        line-height: 1.4;
    }

    .message-input:focus {
        border-color: var(--primary-color);
        background: var(--surface-color);
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }

    .message-input::placeholder {
        color: var(--text-disabled);
    }

    .attachment-button {
        background: none;
        border: none;
        font-size: 20px;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--text-secondary);
        border-radius: 50%;
        transition: all 0.2s;
    }

    .attachment-button:hover,
    .attachment-button:active {
        background: var(--surface-variant);
        color: var(--primary-color);
    }

    .send-button {
        background: var(--primary-color);
        color: white;
        border: none;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .send-button:hover,
    .send-button:active {
        background: var(--primary-dark);
        transform: scale(1.05);
    }

    .send-button:disabled {
        background: var(--border-color);
        cursor: not-allowed;
        transform: none;
    }

    /* Empty States */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-state-text {
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--text-primary);
    }

    .empty-state-subtext {
        font-size: 14px;
        max-width: 300px;
        margin: 0 auto;
        line-height: 1.5;
    }

    /* Loading States */
    .loading {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Modal for image preview */
    .image-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 2000;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .image-modal.active {
        display: flex;
    }

    .image-modal img {
        max-width: 100%;
        max-height: 90%;
        border-radius: 8px;
        object-fit: contain;
    }

    .modal-close {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        font-size: 40px;
        cursor: pointer;
        background: none;
        border: none;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2001;
        opacity: 0.8;
        transition: opacity 0.2s;
    }

    .modal-close:hover {
        opacity: 1;
    }

    /* Shake animation for errors */
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .shake {
        animation: shake 0.5s ease-in-out;
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        :root {
            --surface-color: #121212;
            --surface-variant: #1e1e1e;
            --border-color: #333333;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --text-disabled: #666666;
        }

        body {
            background: var(--surface-color);
        }

        .message.incoming .message-bubble {
            background: #2d2d2d;
        }

        .message.incoming .file-attachment {
            background: #2d2d2d;
        }

        .message.incoming .file-info {
            background: #252525;
        }

        .message-input {
            background: #2d2d2d;
            color: var(--text-primary);
        }

        .message-input:focus {
            background: #2d2d2d;
        }

        .upload-area {
            background: #1e1e1e;
        }

        .upload-button.secondary {
            background: #2d2d2d;
            color: var(--text-primary);
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
// Utility functions - define these first
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function scrollToBottom() {
    const container = document.getElementById('messagesContainer');
    setTimeout(() => {
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }, 100);
}

const receiverId = {{ receiver.id }};
let isSending = false;
let lastMessageId = 0;
let selectedFile = null;
let userStatusInterval = null;

// Navigation functions
function goBack() {
    window.history.back();
}

function showUserMenu() {
    const actions = ['View Profile', 'Block User', 'Clear Chat', 'Report'];
    const actionText = actions.join('\n‚Ä¢ ');
    const action = prompt(`User Actions:\n\n‚Ä¢ ${actionText}\n\nEnter action name:`);

    if (action) {
        handleUserAction(action.trim());
    }
}

function handleUserAction(action) {
    const lowerAction = action.toLowerCase();

    if (lowerAction.includes('profile') || lowerAction.includes('view')) {
        window.location.href = `/profile/${receiverId}`;
    } else if (lowerAction.includes('block')) {
        if (confirm('Are you sure you want to block this user?')) {
            fetch(`/api/block_user/${receiverId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User blocked successfully');
                    goBack();
                } else {
                    alert('Failed to block user: ' + data.error);
                }
            })
            .catch(error => {
                alert('Failed to block user');
                console.error('Error:', error);
            });
        }
    } else if (lowerAction.includes('clear')) {
        if (confirm('Are you sure you want to clear all messages in this chat?')) {
            fetch(`/api/clear_chat/${receiverId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Chat cleared successfully');
                    loadMessages();
                } else {
                    alert('Failed to clear chat: ' + data.error);
                }
            })
            .catch(error => {
                alert('Failed to clear chat');
                console.error('Error:', error);
            });
        }
    } else if (lowerAction.includes('report')) {
        const reason = prompt('Please enter the reason for reporting:');
        if (reason) {
            fetch(`/api/report_user/${receiverId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ reason: reason })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User reported successfully');
                } else {
                    alert('Failed to report user: ' + data.error);
                }
            })
            .catch(error => {
                alert('Failed to report user');
                console.error('Error:', error);
            });
        }
    }
}

// Check user online status
async function checkUserStatus() {
    try {
        const response = await fetch(`/api/user_status/${receiverId}`);
        const data = await response.json();

        const statusElement = document.getElementById('userStatus');
        if (statusElement && data.status) {
            let statusText = '';
            let statusColor = '';

            switch(data.status) {
                case 'online':
                    statusText = 'Online';
                    statusColor = 'var(--online-status)';
                    break;
                case 'offline':
                    statusText = 'Offline';
                    statusColor = 'var(--offline-status)';
                    break;
                case 'away':
                    statusText = 'Away';
                    statusColor = 'var(--away-status)';
                    break;
                default:
                    statusText = data.status;
                    statusColor = 'var(--text-secondary)';
            }

            statusElement.textContent = statusText;
            statusElement.style.color = statusColor;

            // Add last seen time if available
            if (data.last_seen && data.status === 'offline') {
                statusElement.textContent = `Last seen ${data.last_seen}`;
            }
        }
    } catch (error) {
        console.error('Error checking user status:', error);
    }
}

function setupMessageInput() {
    const input = document.getElementById('messageInput');
    const form = document.getElementById('messageForm');
    const container = document.getElementById('messagesContainer');

    // Auto-resize textarea
    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        updateSendButton();
    });

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        if (isSending) return;

        const content = input.value.trim();
        if (!content) return;

        isSending = true;

        // Create optimistic UI update
        const tempId = 'temp-' + Date.now();
        const tempMessage = {
            id: tempId,
            content: content,
            sender_name: 'You',
            timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            is_own: true,
            is_read: false
        };

        // Add message immediately to UI
        addMessageToUI(tempMessage, true);
        input.value = '';
        input.style.height = 'auto';

        // Then send to server
        await sendMessage(content, tempId);
        isSending = false;
    });

    // Enter key to send (Shift+Enter for new line)
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            form.dispatchEvent(new Event('submit'));
        }
    });
}

async function sendMessage(content, tempId) {
    try {
        const response = await fetch('/api/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                receiver_id: receiverId,
                content: content
            })
        });

        const data = await response.json();

        if (data.success) {
            // Remove temporary message and add the real one
            removeTempMessage(tempId);
            addMessageToUI(data.message, true);
            lastMessageId = data.message.id;
        } else {
            // Show error and keep temporary message
            showMessageError(tempId);
        }
    } catch (error) {
        console.error('Error sending message:', error);
        showMessageError(tempId);
    }
}

function removeTempMessage(tempId) {
    const tempMessage = document.querySelector(`[data-message-id="${tempId}"]`);
    if (tempMessage) {
        tempMessage.remove();
    }
}

function showMessageError(tempId) {
    const tempMessage = document.querySelector(`[data-message-id="${tempId}"]`);
    if (tempMessage) {
        tempMessage.classList.add('shake');
        const bubble = tempMessage.querySelector('.message-bubble');
        bubble.style.background = '#ffebee';
        bubble.style.color = '#c62828';

        // Restore after 2 seconds
        setTimeout(() => {
            tempMessage.classList.remove('shake');
            bubble.style.background = '';
            bubble.style.color = '';
        }, 2000);
    }
}

function updateSendButton() {
    const input = document.getElementById('messageInput');
    const button = document.getElementById('sendButton');
    if (input && button) {
        button.disabled = input.value.trim().length === 0;
    }
}

// File upload functions
function toggleUploadArea() {
    const uploadArea = document.getElementById('uploadArea');
    const isActive = uploadArea.classList.toggle('active');

    // Toggle attachment button color
    const attachmentBtn = document.getElementById('attachmentBtn');
    if (isActive) {
        attachmentBtn.style.color = 'var(--primary-color)';
    } else {
        attachmentBtn.style.color = '';
    }
}

function cancelUpload() {
    const uploadArea = document.getElementById('uploadArea');
    uploadArea.classList.remove('active');
    selectedFile = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('uploadFileName').textContent = 'No file selected';

    // Reset attachment button color
    const attachmentBtn = document.getElementById('attachmentBtn');
    if (attachmentBtn) attachmentBtn.style.color = '';
}

function handleFileSelect(files) {
    if (files.length > 0) {
        selectedFile = files[0];
        document.getElementById('uploadFileName').textContent = selectedFile.name;

        // Check file size (16MB limit)
        if (selectedFile.size > 16 * 1024 * 1024) {
            alert('File size must be less than 16MB');
            cancelUpload();
            return;
        }
    }
}

async function uploadFile() {
    if (!selectedFile) {
        alert('Please select a file first');
        return;
    }

    const messageText = document.getElementById('messageInput').value.trim();
    const uploadBtn = document.getElementById('uploadBtn');

    uploadBtn.disabled = true;
    uploadBtn.textContent = 'Uploading...';

    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('receiver_id', receiverId);
    if (messageText) {
        formData.append('message', messageText);
    }

    try {
        const response = await fetch('/upload_file', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Add the message to chat
            addMessageToUI(data.message, true);
            scrollToBottom();

            // Clear inputs
            document.getElementById('messageInput').value = '';
            cancelUpload();
        } else {
            alert('Upload failed: ' + data.error);
        }
    } catch (error) {
        alert('Upload failed. Please try again.');
        console.error('Error:', error);
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload';
    }
}

function setupFileUpload() {
    // Add image preview modal to body
    const modalHTML = `
        <div class="image-modal" id="imageModal">
            <button class="modal-close" onclick="closeImagePreview()">√ó</button>
            <img id="modalImage" src="" alt="Preview">
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function openImagePreview(imageUrl) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    modalImage.src = imageUrl;
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeImagePreview() {
    const modal = document.getElementById('imageModal');
    modal.classList.remove('active');
    document.body.style.overflow = '';
}

// Message display functions
function createMessageElement(message, animate = false) {
    const div = document.createElement('div');
    div.className = `message ${message.is_own ? 'outgoing' : 'incoming'}`;
    div.dataset.messageId = message.id;

    if (animate) {
        div.classList.add('bounce-in');
    }

    let messageHTML = '<div class="message-bubble">';

    // Add file attachment if exists
    if (message.has_attachment) {
        messageHTML += renderFileAttachment(message);
    }

    // Add text content if exists
    if (message.content) {
        messageHTML += `<div class="message-text">${escapeHtml(message.content)}</div>`;
    }

    messageHTML += `
            <div class="message-time">
                ${message.timestamp}
                ${message.is_own ? `<span class="message-status">${message.is_read ? '‚úì‚úì' : '‚úì'}</span>` : ''}
            </div>
        </div>
    `;

    div.innerHTML = messageHTML;
    return div;
}

function renderFileAttachment(message) {
    const fileType = message.file_type || 'unknown';
    const fileName = message.file_name || 'file';
    const fileUrl = message.file_url || '';
    const fileSize = message.file_size || 0;
    const thumbnailUrl = message.thumbnail_url || fileUrl;

    let previewHTML = '';

    switch(fileType.toLowerCase()) {
        case 'image':
        case 'jpg':
        case 'jpeg':
        case 'png':
        case 'gif':
        case 'webp':
            previewHTML = `
                <div class="file-preview">
                    <img src="${thumbnailUrl}" alt="${fileName}"
                         onclick="openImagePreview('${fileUrl}')"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNFNUU1RTUiLz48cGF0aCBkPSJNNzAgODBDNzAgNzIuMjM4MSA3Ni4yMzgxIDY2IDg0IDY2QzkxLjc2MTkgNjYgOTggNzIuMjM4MSA5OCA4MEM5OCA4Ny43NjE5IDkxLjc2MTkgOTQgODQgOTRDNzYuMjM4MSA5NCA3MCA4Ny43NjE5IDcwIDgwWiIgZmlsbD0iI0NDQyIvPjxwYXRoIGQ9Ik02NCAxMTRMMzYgMTQyVjE2NEgxNjRWMTE0TDEzNiA4NkwxMDQgMTE0TDg0IDk0TDY0IDExNFoiIGZpbGw9IiNDQ0MiLz48L3N2Zz4='">
                </div>
            `;
            break;
        case 'document':
        case 'pdf':
        case 'doc':
        case 'docx':
        case 'txt':
            previewHTML = `
                <div class="file-preview">
                    <div class="attachment-icon">üìÑ</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">Document</div>
                </div>
            `;
            break;
        case 'audio':
        case 'mp3':
        case 'wav':
        case 'ogg':
            previewHTML = `
                <div class="file-preview">
                    <div class="attachment-icon">üéµ</div>
                    <audio controls>
                        <source src="${fileUrl}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                </div>
            `;
            break;
        case 'video':
        case 'mp4':
        case 'webm':
        case 'mov':
            previewHTML = `
                <div class="file-preview">
                    <div class="attachment-icon">üé¨</div>
                    <video controls style="max-height: 200px;">
                        <source src="${fileUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            `;
            break;
        default:
            previewHTML = `
                <div class="file-preview">
                    <div class="attachment-icon">üìÅ</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">File Attachment</div>
                </div>
            `;
    }

    return `
        <div class="file-attachment">
            ${previewHTML}
            <div class="file-info">
                <div class="file-name">${escapeHtml(fileName)}</div>
                <div class="file-size">${formatFileSize(fileSize)}</div>
                <a href="${fileUrl}" class="file-download" download="${escapeHtml(fileName)}">Download</a>
            </div>
        </div>
    `;
}

function addMessageToUI(message, animate = false) {
    const container = document.getElementById('messagesContainer');

    // Remove empty state if it exists
    const emptyState = container.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }

    // Remove loading spinner if it exists
    const loading = container.querySelector('.loading');
    if (loading) {
        loading.remove();
    }

    const messageDiv = createMessageElement(message, animate);
    container.appendChild(messageDiv);
    scrollToBottom();
}

async function loadMessages() {
    try {
        const response = await fetch(`/api/messages/${receiverId}`);
        const data = await response.json();

        const container = document.getElementById('messagesContainer');

        if (data.messages && data.messages.length > 0) {
            // Get current last message ID to check if we have new messages
            const currentLastId = data.messages[data.messages.length - 1].id;

            if (currentLastId > lastMessageId) {
                // Only update if we have new messages
                container.innerHTML = '';
                data.messages.forEach(message => {
                    const messageDiv = createMessageElement(message, false);
                    container.appendChild(messageDiv);
                });
                scrollToBottom();
                lastMessageId = currentLastId;
            }
        } else {
            // Remove loading and show empty state
            const loading = container.querySelector('.loading');
            if (loading) {
                loading.remove();
            }
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üí¨</div>
                    <div class="empty-state-text">No messages yet</div>
                    <div class="empty-state-subtext">Send a message to start the conversation!</div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading messages:', error);
    }
}

// Poll for new messages (only load unseen ones)
function startMessagePolling() {
    setInterval(async () => {
        try {
            const response = await fetch(`/api/messages/${receiverId}?after=${lastMessageId}`);
            const data = await response.json();

            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(message => {
                    // Only add messages we haven't seen yet
                    if (message.id > lastMessageId) {
                        addMessageToUI(message, true); // Animate new incoming messages
                        lastMessageId = message.id;
                    }
                });
            }
        } catch (error) {
            console.error('Error polling messages:', error);
        }
    }, 2000);
}

// Poll for user status updates
function startStatusPolling() {
    if (userStatusInterval) clearInterval(userStatusInterval);

    userStatusInterval = setInterval(() => {
        checkUserStatus();
    }, 10000); // Check every 10 seconds
}

// Mark messages as read
async function markMessagesAsRead() {
    try {
        await fetch(`/api/mark_read/${receiverId}`, {
            method: 'POST'
        });
    } catch (error) {
        console.error('Error marking messages as read:', error);
    }
}

// Initialize everything
document.addEventListener('DOMContentLoaded', function() {
    // Define utility functions first
    if (typeof escapeHtml === 'undefined') {
        window.escapeHtml = escapeHtml;
    }

    // Setup all components
    setupMessageInput();
    setupFileUpload();

    // Load messages
    loadMessages();

    // Check user status
    checkUserStatus();
    startStatusPolling();

    // Start polling for new messages
    startMessagePolling();

    // Mark messages as read when opening chat
    markMessagesAsRead();

    // Focus on input field
    const input = document.getElementById('messageInput');
    if (input) {
        input.focus();
    }
});

// Add click outside to close modal
document.addEventListener('click', function(e) {
    const modal = document.getElementById('imageModal');
    if (modal && modal.classList.contains('active') && e.target === modal) {
        closeImagePreview();
    }
});

// Add escape key to close modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImagePreview();
    }
});

// Handle page visibility changes
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        // Page became visible, mark messages as read
        markMessagesAsRead();
        // Reload messages to update read status
        loadMessages();
    }
});

// Close upload area when clicking outside
document.addEventListener('click', function(e) {
    const uploadArea = document.getElementById('uploadArea');
    const attachmentBtn = document.getElementById('attachmentBtn');

    if (uploadArea && uploadArea.classList.contains('active') &&
        attachmentBtn && !uploadArea.contains(e.target) &&
        e.target !== attachmentBtn && !attachmentBtn.contains(e.target)) {
        cancelUpload();
    }
});
</script>
{% endblock %}