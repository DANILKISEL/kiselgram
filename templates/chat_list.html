<!-- templates/chat_list.html -->
{% extends "base.html" %}

{% block content %}
<div class="mobile-app">
    <!-- Header -->
    <div class="header safe-area-top">
        <button class="header-button ripple" onclick="toggleSettings()">â˜°</button>
        <div class="header-title">Chats</div>
        <button class="header-button ripple" onclick="startNewChat()">âœï¸</button>
    </div>

    <!-- Search -->
    <div class="search-bar">
        <input type="text" placeholder="Search" class="search-input" onfocus="openSearch()">
    </div>

    <!-- Chat List -->
    <div class="chat-list" id="chatList">
        {% if chats %}
            {% for chat in chats %}
            <div class="chat-item ripple {% if chat.unread_count > 0 %}unread{% endif %}" 
                 onclick="openChat({{ chat.user.id }})">
                <div class="chat-avatar {% if chat.unread_count > 0 %}pulse{% endif %}">
                    {{ chat.user.username[0]|upper }}
                </div>
                <div class="chat-info">
                    <div class="chat-header">
                        <span class="chat-name">{{ chat.user.username }}</span>
                        <span class="chat-time">{{ chat.timestamp }}</span>
                    </div>
                    <div class="chat-preview">
                        {% if chat.last_message %}
                            {{ chat.last_message.content[:50] }}{% if chat.last_message.content|length > 50 %}...{% endif %}
                        {% else %}
                            No messages yet
                        {% endif %}
                    </div>
                </div>
                {% if chat.unread_count > 0 %}
                <div class="unread-badge">{{ chat.unread_count }}</div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ’¬</div>
            <div class="empty-state-text">No chats yet</div>
            <div class="empty-state-subtext">Start a conversation with someone!</div>
        </div>
        {% endif %}
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav safe-area-bottom">
        <a href="/chat_list" class="nav-item active">
            <div class="nav-icon">ğŸ’¬</div>
            <div class="nav-label">Chats</div>
        </a>
        <a href="/users" class="nav-item">
            <div class="nav-icon">ğŸ‘¥</div>
            <div class="nav-label">Contacts</div>
        </a>
        <a href="/settings" class="nav-item">
            <div class="nav-icon">âš™ï¸</div>
            <div class="nav-label">Settings</div>
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function openChat(userId) {
    window.location.href = `/chat/${userId}`;
}

function toggleSettings() {
    // Implement settings menu
    console.log('Settings toggle');
}

function startNewChat() {
    window.location.href = '/users';
}

function openSearch() {
    window.location.href = '/search';
}

// Update chat list every 5 seconds
setInterval(updateChatList, 5000);

async function updateChatList() {
    try {
        const response = await fetch('/api/chat_list');
        const data = await response.json();
        
        if (data.chats && data.chats.length > 0) {
            // Update chat list dynamically
            const chatList = document.getElementById('chatList');
            // Implementation for dynamic updates
        }
    } catch (error) {
        console.error('Error updating chat list:', error);
    }
}
</script>
{% endblock %}